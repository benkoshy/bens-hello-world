
name: manual-release

on: 
  workflow_dispatch:    

jobs:
  manual-release:
    runs-on: ubuntu-latest

    steps:
 
      - uses: actions/checkout@v2
        # checks out the default branch (which is master)
      
      - uses: ruby/setup-ruby@v1
        with:          
          ruby-version: 3.0.0      
      - run: bundle install
      

      # - name: publish gem
      #   run: |
      #     mkdir -p $HOME/.gem
      #     touch $HOME/.gem/credentials
      #     chmod 0600 $HOME/.gem/credentials
      #     printf -- "---\n:rubygems_api_key: ${GEM_HOST_API_KEY}\n" > $HOME/.gem/credentials
      #     gem build *.gemspec
      #     gem push *.gem
      #   env:
      #     # Make sure to update the secret name
      #     # if yours isn't named RUBYGEMS_AUTH_TOKEN
      #     GEM_HOST_API_KEY: "${{secrets.RUBYGEMS_AUTH_TOKEN}}"

        # now, after the gem has been successfully published
        # we would need to automatically tag based on the current commit
        # ideally we would read the version in the gem file and commit that.

        ## We wanna use this one for pagy
        # echo "::set-output name=version::$(sed -nr "s/.*VERSION\s*=\s*('|\")([^'\"]+).*$/\2/p" $(echo "$GITHUB_WORKSPACE/lib/pagy.rb"))"

      # - name: Get version number
      #   id: version
      #   run: |          
      #     echo "::set-output name=version::$(sed -nr "s/.*VERSION\s*=\s*('|\")([^'\"]+).*$/\2/p" $(echo "$GITHUB_WORKSPACE/lib/bens/hello/world/version.rb"))"
   

      - name: Get version number
        run: echo "VERSION = $(sed -nr "s/.*VERSION\s*=\s*('|\")([^'\"]+).*$/\2/p" $(echo "$GITHUB_WORKSPACE/lib/bens/hello/world/version.rb"))"
      - name: Create tag
        uses: actions/github-script@v3
        with:
          github-token: ${{ github.token }}
          script: |
            github.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/tags/".concat(${{env.VERSION}}),
              sha: context.sha
            })
